{% extends "base.html" %}

{% block title %}Пользователи - WhatsApp Digest Admin{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <div>
            <h1><i class="fas fa-users"></i> Управление пользователями</h1>
            <p class="text-muted">Создание, редактирование и управление пользователями системы</p>
        </div>
        <div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createUserModal">
                <i class="fas fa-user-plus"></i> Создать пользователя
            </button>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-list"></i> Список пользователей</h5>
            </div>
            <div class="card-body">
                {% if users %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Пользователь</th>
                                    <th>Email</th>
                                    <th>Статус</th>
                                    <th>WhatsApp</th>
                                    <th>Telegram</th>
                                    <th>Дайджест</th>
                                    <th>Создан</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr>
                                    <td><span class="badge bg-secondary">{{ user.id }}</span></td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar me-2">
                                                <div class="avatar-circle bg-primary text-white">
                                                    {{ user.username[0].upper() }}
                                                </div>
                                            </div>
                                            <div>
                                                <strong>{{ user.username }}</strong>
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ user.email }}</td>
                                    <td>
                                        {% if user.is_active %}
                                            <span class="badge bg-success">Активен</span>
                                        {% else %}
                                            <span class="badge bg-danger">Неактивен</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if user.whatsapp_connected %}
                                            <div class="d-flex flex-column">
                                                <span class="badge bg-success mb-1">
                                                    <i class="fab fa-whatsapp"></i> Подключен
                                                </span>
                                                <small class="text-muted">{{ user.whatsapp_session_id }}</small>
                                            </div>
                                        {% else %}
                                            <span class="badge bg-danger">
                                                <i class="fas fa-times"></i> Не подключен
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if user.telegram_channel_id %}
                                            <div class="d-flex flex-column">
                                                <span class="badge bg-info mb-1">
                                                    <i class="fab fa-telegram"></i> Настроен
                                                </span>
                                                <small class="text-muted">{{ user.telegram_channel_id }}</small>
                                            </div>
                                        {% else %}
                                            <span class="badge bg-warning">
                                                <i class="fas fa-exclamation"></i> Не настроен
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ user.digest_interval_hours }}ч</span>
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ user.created_at.strftime('%d.%m.%Y %H:%M') }}</small>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="/admin/users/{{ user.id }}" class="btn btn-sm btn-outline-primary" title="Подробно">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            {% if not user.whatsapp_connected %}
                                                <button class="btn btn-sm btn-outline-success" onclick="connectWhatsApp({{ user.id }})" title="Подключить WhatsApp">
                                                    <i class="fab fa-whatsapp"></i>
                                                </button>
                                            {% endif %}
                                            {% if user.is_active %}
                                                <button class="btn btn-sm btn-outline-warning" onclick="suspendUser({{ user.id }}, '{{ user.username }}')" title="Приостановить пользователя">
                                                    <i class="fas fa-pause"></i>
                                                </button>
                                            {% else %}
                                                <button class="btn btn-sm btn-outline-success" onclick="resumeUser({{ user.id }}, '{{ user.username }}')" title="Возобновить пользователя">
                                                    <i class="fas fa-play"></i>
                                                </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-users fa-4x text-muted mb-4"></i>
                        <h4 class="text-muted">Пользователей пока нет</h4>
                        <p class="text-muted">Создайте первого пользователя для начала работы с WhatsApp Digest System</p>
                        <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#createUserModal">
                            <i class="fas fa-user-plus"></i> Создать первого пользователя
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно создания пользователя -->
<div class="modal fade" id="createUserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form action="/admin/users/create" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-plus"></i> Создать нового пользователя
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="username" class="form-label">
                                    <i class="fas fa-user"></i> Имя пользователя
                                </label>
                                <input type="text" class="form-control" id="username" name="username" required>
                                <div class="form-text">Уникальное имя для входа в систему</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="email" class="form-label">
                                    <i class="fas fa-envelope"></i> Email адрес
                                </label>
                                <input type="email" class="form-control" id="email" name="email" required>
                                <div class="form-text">Используется для уведомлений</div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">
                            <i class="fas fa-lock"></i> Пароль
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="password" name="password" required>
                            <button class="btn btn-outline-secondary" type="button" onclick="togglePassword()">
                                <i class="fas fa-eye" id="passwordIcon"></i>
                            </button>
                        </div>
                        <div class="form-text">Минимум 8 символов, рекомендуется использовать сложный пароль</div>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>После создания пользователя:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Пользователь сможет войти в систему через API</li>
                            <li>Необходимо будет подключить WhatsApp через QR-код</li>
                            <li>Настроить Telegram канал для получения дайджестов</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Отмена
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-user-plus"></i> Создать пользователя
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно отображения QR-кода -->
<div class="modal fade" id="qrModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fab fa-whatsapp"></i> Подключение WhatsApp
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div id="qr-progress" class="progress mb-3" style="display: none;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                </div>

                <div id="qr-container">
                    <div class="py-4" id="qr-placeholder">
                        <i class="fas fa-qrcode fa-4x text-muted mb-3"></i>
                        <h5>Инициализация WhatsApp клиента...</h5>
                        <p class="text-muted">Подождите, генерируем QR-код</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Закрыть
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let currentUserId = null;
let currentQRCode = null;
let qrCheckInterval = null;

function togglePassword() {
    const passwordInput = document.getElementById('password');
    const passwordIcon = document.getElementById('passwordIcon');

    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        passwordIcon.classList.remove('fa-eye');
        passwordIcon.classList.add('fa-eye-slash');
    } else {
        passwordInput.type = 'password';
        passwordIcon.classList.remove('fa-eye-slash');
        passwordIcon.classList.add('fa-eye');
    }
}

async function connectWhatsApp(userId) {
    currentUserId = userId;
    const button = event.target.closest('button');
    const originalContent = button.innerHTML;

    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

    // Показываем модальное окно
    const qrModal = new bootstrap.Modal(document.getElementById('qrModal'));
    qrModal.show();

    // Сбрасываем содержимое контейнера
    const container = document.getElementById('qr-container');
    container.innerHTML = `
        <div class="py-4" id="qr-placeholder">
            <i class="fas fa-spinner fa-spin fa-3x text-primary mb-3"></i>
            <h5>Инициализация WhatsApp клиента...</h5>
            <p class="text-muted">Подождите, генерируем QR-код</p>
        </div>
    `;

    // Показываем прогресс бар
    const progressBar = document.getElementById('qr-progress');
    progressBar.style.display = 'block';
    animateProgressBar();

    try {
        const response = await fetch(`/admin/users/${userId}/qr`);
        const result = await response.json();

        if (result.status === 'success' && result.qr_code) {
            // QR-код готов
            displayQRCode(result.qr_code, result.timestamp);
            startQRCodeMonitoring();
        } else if (result.status === 'pending' || result.status === 'success') {
            // Клиент инициализирован, ждем QR-код
            showWaitingForQR();
            startQRCodeCheck();
        } else {
            showError(result.message);
        }
    } catch (error) {
        showError('Ошибка подключения: ' + error.message);
    } finally {
        progressBar.style.display = 'none';
        button.disabled = false;
        button.innerHTML = originalContent;
    }
}

function displayQRCode(qrCodeDataUrl, timestamp) {
    const container = document.getElementById('qr-container');
    currentQRCode = qrCodeDataUrl;

    container.innerHTML = `
        <div class="qr-code-display">
            <div class="mb-3">
                <img src="${qrCodeDataUrl}" alt="WhatsApp QR Code"
                     class="img-fluid border rounded shadow"
                     style="max-width: 256px; max-height: 256px;">
            </div>
            <h6 class="text-success">
                <i class="fas fa-qrcode"></i> QR-код готов к сканированию
            </h6>
            <p class="text-muted small">
                Создан: ${new Date(timestamp).toLocaleString('ru-RU')}
            </p>
            <div class="d-flex gap-2 justify-content-center flex-wrap mb-3">
                <button class="btn btn-outline-success btn-sm" onclick="refreshQRCode()" title="Обновить QR-код">
                    <i class="fas fa-sync"></i> Обновить
                </button>
                <button class="btn btn-outline-primary btn-sm" onclick="downloadQRCode()" title="Скачать QR-код">
                    <i class="fas fa-download"></i> Скачать
                </button>
            </div>

            <div class="alert alert-info">
                <i class="fas fa-mobile-alt"></i> <strong>Инструкция:</strong>
                <ol class="mb-0 mt-2">
                    <li>Откройте WhatsApp на телефоне</li>
                    <li>Меню → "Связанные устройства"</li>
                    <li>"Привязать устройство"</li>
                    <li>Отсканируйте этот QR-код</li>
                </ol>
            </div>
        </div>
    `;
}

function showWaitingForQR() {
    const container = document.getElementById('qr-container');
    container.innerHTML = `
        <div class="py-4">
            <i class="fas fa-hourglass-half fa-3x text-warning mb-3"></i>
            <h5>Ожидание QR-кода...</h5>
            <p class="text-muted">QR-код генерируется, подождите несколько секунд</p>
        </div>
    `;
}

function showError(message) {
    const container = document.getElementById('qr-container');
    container.innerHTML = `
        <div class="py-4">
            <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
            <h5>Ошибка</h5>
            <p class="text-danger">${message}</p>
            <button class="btn btn-primary" onclick="connectWhatsApp(${currentUserId})">
                <i class="fas fa-redo"></i> Попробовать снова
            </button>
        </div>
    `;
}

function startQRCodeCheck() {
    if (qrCheckInterval) clearInterval(qrCheckInterval);

    qrCheckInterval = setInterval(async () => {
        try {
            const response = await fetch(`/admin/users/${currentUserId}/qr`);
            const result = await response.json();

            if (result.status === 'success' && result.qr_code) {
                clearInterval(qrCheckInterval);
                displayQRCode(result.qr_code, result.timestamp);
                startQRCodeMonitoring();
            }
        } catch (error) {
            console.error('Error checking QR code:', error);
        }
    }, 2000);
}

function startQRCodeMonitoring() {
    // Проверяем статус подключения каждые 5 секунд
    const monitoringInterval = setInterval(async () => {
        try {
            const response = await fetch(`/admin/users/${currentUserId}`);
            const userData = await response.json();

            if (userData.whatsapp_connected) {
                clearInterval(monitoringInterval);
                showConnectionSuccess();
                setTimeout(() => {
                    location.reload();
                }, 3000);
            }
        } catch (error) {
            console.error('Error monitoring connection:', error);
        }
    }, 5000);
}

function showConnectionSuccess() {
    const container = document.getElementById('qr-container');
    container.innerHTML = `
        <div class="py-4">
            <i class="fas fa-check-circle fa-4x text-success mb-3"></i>
            <h5 class="text-success">WhatsApp подключен успешно!</h5>
            <p class="text-muted">Страница перезагрузится через несколько секунд</p>
        </div>
    `;
}

function refreshQRCode() {
    connectWhatsApp(currentUserId);
}

function downloadQRCode() {
    if (currentQRCode) {
        const link = document.createElement('a');
        link.download = `whatsapp-qr-user-${currentUserId}.png`;
        link.href = currentQRCode;
        link.click();
    }
}

function animateProgressBar() {
    const progressBar = document.querySelector('#qr-progress .progress-bar');
    if (!progressBar) return;

    let progress = 0;
    const interval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress >= 90) {
            clearInterval(interval);
            progress = 90;
        }
        progressBar.style.width = progress + '%';
    }, 200);
}

// Очищаем интервалы при закрытии модального окна
document.getElementById('qrModal').addEventListener('hidden.bs.modal', function () {
    if (qrCheckInterval) {
        clearInterval(qrCheckInterval);
        qrCheckInterval = null;
    }
});

// Функции для управления статусом пользователей
async function suspendUser(userId, username) {
    if (!confirm(`Вы уверены, что хотите приостановить пользователя "${username}"?\n\nПриостановленный пользователь не сможет получать дайджесты.`)) {
        return;
    }

    try {
        const response = await fetch(`/admin/users/${userId}/suspend`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        if (response.ok) {
            showAlert('success', `Пользователь "${username}" успешно приостановлен`);
            setTimeout(() => location.reload(), 1500);
        } else {
            const error = await response.json();
            showAlert('danger', `Ошибка при приостановке пользователя: ${error.detail}`);
        }
    } catch (error) {
        console.error('Error suspending user:', error);
        showAlert('danger', 'Ошибка при приостановке пользователя');
    }
}

async function resumeUser(userId, username) {
    if (!confirm(`Вы уверены, что хотите возобновить пользователя "${username}"?\n\nПользователь снова сможет получать дайджесты.`)) {
        return;
    }

    try {
        const response = await fetch(`/admin/users/${userId}/resume`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        if (response.ok) {
            showAlert('success', `Пользователь "${username}" успешно возобновлен`);
            setTimeout(() => location.reload(), 1500);
        } else {
            const error = await response.json();
            showAlert('danger', `Ошибка при возобновлении пользователя: ${error.detail}`);
        }
    } catch (error) {
        console.error('Error resuming user:', error);
        showAlert('danger', 'Ошибка при возобновлении пользователя');
    }
}

function showAlert(type, message) {
    const alertContainer = document.createElement('div');
    alertContainer.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertContainer.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertContainer.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(alertContainer);

    // Автоматически скрыть через 5 секунд
    setTimeout(() => {
        if (alertContainer.parentNode) {
            alertContainer.remove();
        }
    }, 5000);
}
</script>

<style>
.avatar-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

.qr-code-display {
    max-width: 300px;
    margin: 0 auto;
}

.progress {
    height: 5px;
}
</style>
{% endblock %}
